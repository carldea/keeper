<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <title>KeeperPlugin</title>
<link href="../../../../../../images/logo-icon.svg" rel="icon" type="image/svg"><script>var pathToRoot = "../../../";</script><script type="text/javascript" src="../../../scripts/sourceset_dependencies.js" async="async"></script><link href="../../../styles/style.css" rel="Stylesheet"><link href="../../../styles/logo-styles.css" rel="Stylesheet"><link href="../../../styles/jetbrains-mono.css" rel="Stylesheet"><link href="../../../styles/main.css" rel="Stylesheet"><script type="text/javascript" src="../../../scripts/clipboard.js" async="async"></script><script type="text/javascript" src="../../../scripts/navigation-loader.js" async="async"></script><script type="text/javascript" src="../../../scripts/platform-content-handler.js" async="async"></script><script type="text/javascript" src="../../../scripts/main.js" async="async"></script>  </head>
  <body>
    <div id="container">
      <div id="leftColumn"><a href="../../../index.html">
          <div id="logo"></div>
        </a>
        <div id="paneSearch"></div>
        <div id="sideMenu"></div>
      </div>
      <div id="main">
        <div id="leftToggler"><span class="icon-toggler"></span></div>
<script type="text/javascript" src="../../../scripts/main.js"></script>        <div class="main-content" id="content" pageIds="keeper-gradle-plugin::com.slack.keeper/KeeperPlugin///PointingToDeclaration//769193423">
          <div class="navigation-wrapper" id="navigation-wrapper">
            <div class="breadcrumbs"><a href="../../../index.html">keeper-gradle-plugin</a>/<a href="../index.html">com.slack.keeper</a>/<a href="index.html">KeeperPlugin</a></div>
            <div class="pull-right d-flex">
              <div id="searchBar"></div>
            </div>
          </div>
          <div class="cover ">
            <h1 class="cover"><span>Keeper</span><wbr></wbr><span>Plugin</span></h1>
            <div class="platform-hinted " data-platform-hinted="data-platform-hinted"><div class="content sourceset-depenent-content" data-active="" data-togglable=":dokkaHtml/main"><div class="symbol monospace">class <a href="index.html">KeeperPlugin</a> : <a href="https://docs.gradle.org/7.0.2/javadoc/index.html/org/gradle/api/Plugin.html">Plugin</a>&lt;<a href="https://docs.gradle.org/7.0.2/javadoc/index.html/org/gradle/api/Project.html">Project</a>&gt; <span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div><p class="paragraph">A simple Gradle plugin that hooks into Proguard/R8 to add extra keep rules based on what androidTest classes use from the target app's sources. This is necessary because AGP does not factor in androidTest usages of target app sources when running the minification step, which can result in runtime errors if APIs used by tests are removed.</p><p class="paragraph">This is a workaround until AGP supports this: https://issuetracker.google.com/issues/126429384.</p><p class="paragraph">This is optionally configurable via the <a href="../-keeper-extension/index.html"><code>keeper</code></a> extension. For example:</p><div class="sample-container"><code class="" theme="idea"><pre>keeper {<br>  automaticR8RepoManagement = false<br>  r8JvmArgs = [&quot;-Xdebug&quot;, &quot;-Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=y&quot;]<br>}</pre></code></div><p class="paragraph">The general logic flow:</p><ul><li><p class="paragraph">Create a custom <code>r8</code> configuration for the R8 dependency.</p></li><li><p class="paragraph">Register two jar tasks. One for all the classes in its target <code>testedVariant</code> and one for all the classes in the androidTest variant itself. This will use their variant-provided <a href="https://docs.gradle.org/7.0.2/javadoc/index.html/org/gradle/api/tasks/compile/JavaCompile.html">JavaCompile</a> tasks and <span data-unresolved-link="org.jetbrains.kotlin.gradle.tasks/KotlinCompile///PointingToDeclaration/">KotlinCompile</span> tasks if available.</p></li><li><p class="paragraph">Register a <a href="../-infer-android-test-keep-rules/index.html"><code>infer${androidTestVariant}UsageForKeeper</code></a> task that plugs the two aforementioned jars into R8's <code>PrintUses</code> CLI and outputs the inferred proguard rules into a new intermediate .pro file.</p></li><li><p class="paragraph">Finally - the generated file is wired in to Proguard/R8 via private task APIs and setting their <code>configurationFiles</code> to include our generated one.</p></li></ul><p class="paragraph">Appropriate task dependencies (via inputs/outputs, not <code>dependsOn</code>) are set up, so this is automatically run as part of the target app variant's full minified APK.</p><p class="paragraph">The tasks themselves take roughly ~20 seconds total extra work in the Slack android app, with the infer and app jar tasks each taking around 8-10 seconds and the androidTest jar taking around 2 seconds.</p></div></div>
          </div>
          <div class="tabbedcontent">
            <div class="tabs-section" tabs-section="tabs-section"><button class="section-tab" data-active="" data-togglable="Constructors">Constructors</button><button class="section-tab" data-togglable="Functions">Functions</button></div>
            <div class="tabs-section-body">
              <h2 class="tabbedcontent">Constructors</h2>
              <div class="table" data-togglable="Constructors"><a data-name="1871676864%2FConstructors%2F769193423" anchor-label="KeeperPlugin" id="1871676864%2FConstructors%2F769193423" data-filterable-set=":dokkaHtml/main"></a>
                <div class="table-row" data-filterable-current=":dokkaHtml/main" data-filterable-set=":dokkaHtml/main">
                  <div class="main-subrow keyValue TabbedContent">
                    <div class=""><span class="inline-flex"><a href="-keeper-plugin.html">KeeperPlugin</a><span class="anchor-wrapper"><span class="anchor-icon" pointing-to="1871676864%2FConstructors%2F769193423"></span>
                          <div class="copy-popup-wrapper "><span class="copy-popup-icon"></span><span>Link copied to clipboard</span></div>
                        </span></span></div>
                    <div>
                      <div class="title">
                        <div class="platform-hinted " data-platform-hinted="data-platform-hinted"><div class="content sourceset-depenent-content" data-active="" data-togglable=":dokkaHtml/main"><div class="symbol monospace">fun <a href="-keeper-plugin.html">KeeperPlugin</a>()<span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div></div></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <h2 class="">Functions</h2>
              <div class="table" data-togglable="Functions"><a data-name="-1639140097%2FFunctions%2F769193423" anchor-label="apply" id="-1639140097%2FFunctions%2F769193423" data-filterable-set=":dokkaHtml/main"></a>
                <div class="table-row" data-filterable-current=":dokkaHtml/main" data-filterable-set=":dokkaHtml/main">
                  <div class="main-subrow keyValue ">
                    <div class=""><span class="inline-flex"><a href="apply.html">apply</a><span class="anchor-wrapper"><span class="anchor-icon" pointing-to="-1639140097%2FFunctions%2F769193423"></span>
                          <div class="copy-popup-wrapper "><span class="copy-popup-icon"></span><span>Link copied to clipboard</span></div>
                        </span></span></div>
                    <div>
                      <div class="title"><div class="divergent-group" data-filterable-current=":dokkaHtml/main" data-filterable-set=":dokkaHtml/main"><div class="with-platform-tags"><span class="pull-right"></span></div>

  <div>
    <div class="platform-hinted " data-platform-hinted="data-platform-hinted"><div class="content sourceset-depenent-content" data-active="" data-togglable=":dokkaHtml/main"><div class="symbol monospace">open override fun <a href="apply.html">apply</a>(project: <a href="https://docs.gradle.org/7.0.2/javadoc/index.html/org/gradle/api/Project.html">Project</a>)<span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div></div></div>
  </div>
</div>
</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="footer"><span class="go-to-top-icon"><a href="#content"></a></span><span>Â© 2021 Copyright</span><span class="pull-right"><span>Generated by </span><a href="https://github.com/Kotlin/dokka"><span>dokka</span><span class="padded-icon"></span></a></span></div>
      </div>
    </div>
  </body>
</html>

